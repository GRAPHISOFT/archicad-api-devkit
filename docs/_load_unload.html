<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Archicad C++ API" />
<meta property="og:image" content="logo.svg" />
<meta property="og:description" content="Archicad Development Kit Documentation, best practices, example codes and information hub." />
<meta property="og:url" content="https://archicadapi.graphisoft.com/documentation/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="logo.svg" />
<meta name="twitter:title" content="Archicad C++ API" />
<meta name="twitter:description" content="Archicad Development Kit Documentation, best practices, example codes and information hub." />
<!-- END twitter metadata -->
<title>Archicad 29 C++ API: Control the Load/Unload Mechanism</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.cdnfonts.com/css/proxima-nova-2" rel="stylesheet">
<link rel="icon" href="logo.svg" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Archicad 29 C++ API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('_load_unload.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Control the Load/Unload Mechanism</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Remember that every add-on is a DLL on Windows and a bundle on the Macintosh. If the user invokes any of the add-on commands, the add-on is loaded into memory, then the appropriate command is executed, and finally, the add-on is purged from the memory.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
The default calling mechanism</h2>
<ul>
<li>the add-on Manager loads the add-on, and</li>
<li>calls its <a class="el" href="group___add_on_lifetime.html#gaf36d63d09853e5344932b63ee23d2bb9">CheckEnvironment</a> function, then</li>
<li>calls its <a class="el" href="group___add_on_lifetime.html#ga3d5b6a23422e44dce66728b0f4eb943e">RegisterInterface</a> function</li>
<li>the add-on is unloaded if it doesn't have to be preloaded/kept in memory</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Loading add-ons on user request</h2>
<ul>
<li>the add-on is loaded into the memory if necessary</li>
<li>the <a class="el" href="group___add_on_lifetime.html#gaa8f1f7d553305c1afe5de7e4dcb66e99">Initialize</a> function is called</li>
<li>the appropriate handler function is called</li>
<li>the <a class="el" href="group___add_on_lifetime.html#ga04d82e269703a9b433002bbe20f1d3b2">FreeData</a> function is called</li>
<li>the add-on is unloaded if doesn't have to be kept in memory</li>
</ul>
<p>This default scheme is quite inconvenient if the functionality needs a complex initialization/termination procedure. Suppose that an add-on is working on an external database too. If the user needs any information stored in that database, first it must be initialized, then the links must be set up to the Archicad database. It can take a significant amount of time.</p>
<p>A better solution can be if the add-on can initialize itself only once, no matter how many user commands are invoked. Of course, it can be implemented if your add-on is kept in the memory between several user interactions only. This is the only way to preserve the initialized global variables, dynamic memory blocks, etc.</p>
<p>The solution is to call the <a class="el" href="group___add_on_lifetime.html#ga94e03de5747d369df034c790ea8c2513">ACAPI_KeepInMemory</a> function, while any of the handler functions are executed. Some operations (e.g. when an add-on has its palette, or registers a notification handler) cause the add-on to stay in memory without calling this function.</p>
<p>In this case, the add-on will NOT be UNLOADED from the memory upon return from the callback function. The add-on remains loaded, which means that the <a class="el" href="group___add_on_lifetime.html#ga04d82e269703a9b433002bbe20f1d3b2">FreeData</a> function will not be called, of course. In this case, it is not necessary to load the add-on into the memory upon the next user request, so the <a class="el" href="group___add_on_lifetime.html#gaa8f1f7d553305c1afe5de7e4dcb66e99">Initialize</a> function will not be called also that time. The server application keeps calling the registered callback function(s) only.</p>
<p>The rules are very easy:</p>
<ul>
<li>the <a class="el" href="group___add_on_lifetime.html#gaa8f1f7d553305c1afe5de7e4dcb66e99">Initialize</a> function is called just after the add-on is loaded into the memory physically,</li>
<li>the appropriate callback function is called when the Initialize function has been executed and returns successfully,</li>
<li>the <a class="el" href="group___add_on_lifetime.html#ga04d82e269703a9b433002bbe20f1d3b2">FreeData</a> function is called just before the add-on must be swapped out. <br  />
 An add-on must be unloaded when the last handler function has not called the <a class="el" href="group___add_on_lifetime.html#ga94e03de5747d369df034c790ea8c2513">ACAPI_KeepInMemory</a> function, all the palettes have been dismissed, and all the registered notification handlers have been unregistered.</li>
</ul>
<p><em>Note:</em> if you have global variables, they will be initialized each time the add-on is loaded, and destroyed each time the add-on is unloaded. This may mean three initialization and termination sequences for a simple add-on command. This can have a severe impact on your add-on's performance and on the startup time of the server application, especially if you have instances of complex C++ classes as global variables. Also, the API (and most other modules') services are not available during the construction and destruction of these global variables, so e.g. you cannot use the BM Memory Manager there. This leads to nice crashes in the past; the solution is to use only pointers and construct the global instances only in your initialize function.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
The controlled calling mechanism</h2>
<p>According to the above rules you can prevent yourself from unloading from the memory by the server application.</p>
<ul>
<li>user request</li>
<li>the add-on is loaded into the memory<ul>
<li><code>Initialize</code> is called</li>
<li>a handler function is called<ul>
<li><code>ACAPI_KeepInMemory</code> called by the add-on</li>
</ul>
</li>
</ul>
</li>
<li>user request<ul>
<li>a handler function is called<ul>
<li><code>ACAPI_KeepInMemory</code> called by the add-on</li>
</ul>
</li>
</ul>
</li>
<li>user request<ul>
<li>a handler function is called<ul>
<li><code>ACAPI_KeepInMemory</code> called by the add-on</li>
</ul>
</li>
</ul>
</li>
<li>user request<ul>
<li>a handler function is called</li>
<li><code>FreeData</code> is called</li>
</ul>
</li>
<li>the add-on is unloaded</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
Important</h2>
<p>You may have serious problems if you use this feature without enough care.</p>
<p>An example: You initialize your data structure according to the actual Archicad database. Your code is kept in the memory, but between two commands the user opens another Archicad project, or closes the active one, etc. In such cases, your initialization process may fail because the add-on still stores data from the previous project.</p>
<p>To control these events, you must handle the notification codes sent by Archicad. They are documented in the <a class="el" href="group___notification.html">Notification Manager</a>. By tracking these notification codes, you will be informed by Archicad if the user opens a new project, closes the active one, creates a completely new one, or even if the user quits Archicad. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</body>
</html>
