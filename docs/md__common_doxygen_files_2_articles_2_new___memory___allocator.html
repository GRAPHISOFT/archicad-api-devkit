<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="Archicad C++ API" />
<meta property="og:image" content="logo.svg" />
<meta property="og:description" content="Archicad Development Kit Documentation, best practices, example codes and information hub." />
<meta property="og:url" content="https://archicadapi.graphisoft.com/documentation/" />
<!-- END opengraph metadata -->
<!-- BEGIN twitter metadata -->
<meta name="twitter:image:src" content="logo.svg" />
<meta name="twitter:title" content="Archicad C++ API" />
<meta name="twitter:description" content="Archicad Development Kit Documentation, best practices, example codes and information hub." />
<!-- END twitter metadata -->
<title>Archicad 28 C++ API: New memory allocator in Archicad 28</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="https://fonts.cdnfonts.com/css/proxima-nova-2" rel="stylesheet">
<link rel="icon" href="logo.svg" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Archicad 28 C++ API
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__common_doxygen_files_2_articles_2_new___memory___allocator.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">New memory allocator in Archicad 28 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="TBB"></a> Since version 28, Archicad uses a custom memory allocator (TBB) on Windows instead of the system default. This change can cause new memory-related bugs if allocators are used inconsistently, such as freeing memory allocated by the system allocator with TBB or the other way around, leading to crashes.</p>
<h2><a class="anchor" id="autotoc_md63"></a>
Symptoms of inconsistent memory handling</h2>
<ul>
<li>Crashes in tbbmalloc.dll or ucrtbase.dll when freeing or reallocating memory. The memory address passed to the crashing operation is usually the memory that was handled inconsistently.</li>
<li>The crash might not be deterministic as the inconsistently used free operation is not guaranteed to crash. Often, it only results in a memory leak instead of a fatal error.</li>
<li>Turn on ProtectedAlloc to reliably detect inconsistent allocator use and other memory-related problems. Set "Computer\HKEY_CURRENT_USER\SOFTWARE\GRAPHISOFT\Debug\GSRoot\MemoryManager\useProtectedAlloc" REG_DWORD type registry value from the default 0 to 1. (Using protected alloc significantly slows down Archicad and increases memory use.) *</li>
<li>Crashes occur only on Windows.</li>
<li>Crashes disappear when using the system allocator. Change "Computer\HKEY_CURRENT_USER\SOFTWARE\GRAPHISOFT\Debug\GSRoot\MemoryManager\memoryManagerType" REG_SZ type registry value from the default 0 to 2 (System) to force using the system allocator. This way, the inconsistent allocator use can’t happen. If the crash disappears with this setting, it was likely caused by inconsistent allocator use. *</li>
</ul>
<p>*Don't forget to restore debug registry values to their default values before final testing.</p>
<h2><a class="anchor" id="autotoc_md64"></a>
Fixing the problem</h2>
<ul>
<li>Include "Support/Modules/GSRoot/GSMalloc.hpp" and "Support/Modules/GSRoot/GSNew.hpp" in all your Add-On module translation units (e.g., via force include or precompiled headers) to use Archicad’s custom allocator. This will override all memory operations (new/delete, malloc/free, etc.) in the module to use Archicad’s custom allocator.</li>
<li>The above headers are already added to the Add-On module precompiled header if you use the latest version of the Archicad Add-On CMake template (<a href="https://github.com/GRAPHISOFT/archicad-addon-cmake">https://github.com/GRAPHISOFT/archicad-addon-cmake</a>)</li>
<li>If your Add-On consists of multiple modules, all other modules should also use the above-precompiled header settings and link to GSRootImp.lib.</li>
<li>3rd party binary libraries you can’t rebuild with the above settings might also cause allocation inconsistency problems if they expose memory allocations, i.e., if the library interface is designed in a way that the caller needs to free library-allocated memory or the library frees caller-allocated memory. Possible workarounds are:<ul>
<li>Many libraries allow the caller to customize their memory allocation and deallocation operations. To guarantee consistent allocator use, redirect memory allocation and deallocation to the GSRoot-provided malloc and free.</li>
<li>Wrap the 3rd party library in a wrapper module. The module should provide an interface that doesn’t expose the library’s or its memory allocations to the rest of your Add-On. Please don’t use any Archicad DevKit headers from this wrapper module, and don’t link it to DevKit modules. This way, both the wrapper and the wrapped module will use the system-provided allocator on Windows. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</body>
</html>